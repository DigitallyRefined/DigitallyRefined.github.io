"use strict";(globalThis.webpackChunkdigitally_refined=globalThis.webpackChunkdigitally_refined||[]).push([[11],{5328(e,n,a){a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>t,metadata:()=>s,toc:()=>h});var s=a(5883),l=a(4848),i=a(8453),o=a(4252),r=a(7833);const t={slug:"/guides/Tailscale-Headscale-setup",tags:["Tailscale","VPN","Tunnelling","Self-hosting","Docker","YouTube","Video"],last_update:{date:new Date("2024-05-19T00:00:00.000Z")}},c="Tailscale & Headscale",d={authorsImageUrls:[]},h=[{value:"Setting up your own self hosted remote access",id:"setting-up-your-own-self-hosted-remote-access",level:2},{value:"Video",id:"video",level:2},{value:"Installation",id:"installation",level:2},{value:"Fly.io client",id:"flyio-client",level:3},{value:"Fly.io deployment",id:"flyio-deployment",level:3},{value:"Launching the Fly.io app",id:"launching-the-flyio-app",level:3},{value:"Setting up the Fly.io docker-wireguard-tunnel",id:"setting-up-the-flyio-docker-wireguard-tunnel",level:3},{value:"Install Docker community edition via the convenience script",id:"install-docker-community-edition-via-the-convenience-script",level:3},{value:"Configuring Headscale",id:"configuring-headscale",level:3},{value:"Create a new user for your Headscale server",id:"create-a-new-user-for-your-headscale-server",level:4},{value:"Joining Tailscale clients to the network using your custom control server URL",id:"joining-tailscale-clients-to-the-network-using-your-custom-control-server-url",level:3},{value:"Registering a new device and allowing it to join your network",id:"registering-a-new-device-and-allowing-it-to-join-your-network",level:4},{value:"Docker compose setup to run Tailscale on Linux",id:"docker-compose-setup-to-run-tailscale-on-linux",level:3},{value:"Create a new preauth key",id:"create-a-new-preauth-key",level:4},{value:"docker-compose.yml",id:"docker-composeyml",level:4},{value:"Additional resources",id:"additional-resources",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h2,{id:"setting-up-your-own-self-hosted-remote-access",children:"Setting up your own self hosted remote access"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.a,{href:"https://headscale.net/",children:"Headscale"})," is an open source implementation of the ",(0,l.jsx)(n.a,{href:"https://tailscale.com/",children:"Tailscale"})," coordination server."]}),"\n",(0,l.jsx)(n.p,{children:"This guide will step through setting up your own self hosted private and secure remote access using Tailscale clients along with a self hosted Headscale Docker container."}),"\n","\n",(0,l.jsxs)(n.admonition,{type:"warning",children:[(0,l.jsx)(n.p,{children:"Mentions of this being a free service in the video below are now no longer correct:"}),(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"To launch a server, a credit card is now required  (a temporary charge between $1-$10 will be taken to verify it)"}),"\n",(0,l.jsxs)(n.li,{children:["Fly.io no longer offer free ",(0,l.jsx)(n.a,{href:"https://fly.io/docs/about/pricing/#anycast-ip-addresses",children:"dedicated IPv4 addresses"}),", these are now charged at $2/month for each IPv4 address."]}),"\n",(0,l.jsxs)(n.li,{children:["Fly.io gives new accounts ",(0,l.jsx)(n.a,{href:"https://fly.io/docs/about/pricing/#new-customers-get-a-free-trial",children:"$5 of free trial credit and Hobby plans cost $5 per month"}),"."]}),"\n"]}),(0,l.jsxs)(n.p,{children:["So in theory as long as you don't exceed the $5 free trial credit, this setup should still be free. Make sure that you check ",(0,l.jsx)(n.a,{href:"https://fly.io/docs/about/pricing/#free-allowances",children:"their current free allowances"}),", as they may have changed since this guide was last published."]})]}),"\n","\n",(0,l.jsx)(o.A,{toc:h}),"\n",(0,l.jsx)(n.h2,{id:"video",children:"Video"}),"\n","\n",(0,l.jsx)(r.Ay,{id:"rGJ5RvB_aBg",title:"Tailscale & Headscale - Setting up your own self hosted remote access",poster:"maxresdefault",webp:!0}),"\n",(0,l.jsx)("a",{href:"https://youtu.be/rGJ5RvB_aBg",children:"Watch on YouTube"}),"\n",(0,l.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,l.jsx)(n.h3,{id:"flyio-client",children:"Fly.io client"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"sudo apt install curl\ncurl -L https://fly.io/install.sh | sh\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"echo 'export FLYCTL_INSTALL=\"$HOME/.fly\"' >> ~/.bashrc\necho 'export PATH=\"$FLYCTL_INSTALL/bin:$PATH\"' >> ~/.bashrc\nsource ~/.bashrc\n"})}),"\n",(0,l.jsx)(n.h3,{id:"flyio-deployment",children:"Fly.io deployment"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir fly-tunnel\ncd fly-tunnel\nnano fly.toml\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Note: you can update ",(0,l.jsx)(n.code,{children:"choose-a-subdomain-1234"})," and ",(0,l.jsx)(n.code,{children:"my-user"})," to any value you'd like to use."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-toml",children:'# fly.toml app configuration file\n#\n# See https://fly.io/docs/reference/configuration/ for information about how to use this file.\n#\n\napp = "choose-a-subdomain-1234"\n\n[build]\n  image = "ghcr.io/digitallyrefined/docker-wireguard-tunnel:v3"\n\n[env]\n  DOMAIN = "choose-a-subdomain-1234.fly.dev"\n  PEERS = "1"\n  SERVICES = "peer1:headscale:80:80,peer1:headscale:443:443"\n\n[[mounts]]\n  source = "wireguard_data"\n  destination = "/etc/wireguard"\n\n[[services]]\n  protocol = "udp"\n  internal_port = 51820\n\n  [[services.ports]]\n    port = 51820\n\n[[services]]\n  protocol = "tcp"\n  internal_port = 80\n\n  [[services.ports]]\n    port = 80\n\n[[services]]\n  protocol = "tcp"\n  internal_port = 443\n\n  [[services.ports]]\n    port = 443\n'})}),"\n",(0,l.jsx)(n.h3,{id:"launching-the-flyio-app",children:"Launching the Fly.io app"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://fly.io/app/sign-up",children:"Sign up for a Fly.io account"})}),"\n",(0,l.jsx)(n.admonition,{type:"warning",children:(0,l.jsxs)(n.p,{children:["Make sure that you check ",(0,l.jsx)(n.a,{href:"https://fly.io/docs/about/pricing/#free-allowances",children:"Fly.io's current free allowances"}),", as they may have changed since this guide was last published."]})}),"\n",(0,l.jsxs)(n.p,{children:["This setup uses 1 Fly.io app. As long as you don't have more than 3 Fly.io apps running you wont be exceeding ",(0,l.jsx)(n.a,{href:"https://fly.io/docs/about/pricing/#free-allowances",children:"Fly.io's free allowance"})," in terms of server usage, however dedicated IPv4 addresses are now a ",(0,l.jsx)(n.a,{href:"https://fly.io/docs/about/pricing/#anycast-ip-addresses",children:"paid for feature"}),", so you will need to add a credit card to launch this app. You can use a temporary credit card from ",(0,l.jsx)(n.a,{href:"https://privacy.com/",children:"privacy.com"})," in the US or ",(0,l.jsx)(n.a,{href:"https://www.revolut.com/",children:"Revolut"})," in some parts of Europe."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"fly auth login\nfly launch\n"})}),"\n",(0,l.jsx)(n.p,{children:"Use the following options:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"? Would you like to copy its configuration to the new app? Yes\n? Choose an app name (leaving blank will default to 'choose-a-subdomain-1234') choose-a-subdomain-1234\n? Choose a region for deployment: Denver, Colorado (US) (den) # Or a location closest to you\n? Would you like to set up a Postgresql database now? No\n? Would you like to set up an Upstash Redis database now? No\n? Would you like to deploy now? Yes\n? Would you like to allocate a dedicated ipv4 address now? Yes\n"})}),"\n",(0,l.jsxs)(n.h3,{id:"setting-up-the-flyio-docker-wireguard-tunnel",children:["Setting up the Fly.io ",(0,l.jsx)(n.a,{href:"https://github.com/DigitallyRefined/docker-wireguard-tunnel",children:"docker-wireguard-tunnel"})]}),"\n",(0,l.jsxs)(n.p,{children:["Once the Fly.io tunnel has started, a ",(0,l.jsx)(n.code,{children:"peer1.conf"})," file will be automatically generated in the ",(0,l.jsx)(n.code,{children:"/etc/wireguard"})," directory, it can be viewed and then removed via:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"fly ssh console\ncat /etc/wireguard/peer1.conf\n# Copy the contents of peer1.conf\nrm /etc/wireguard/peer1.conf\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Now we'll create a new folder called ",(0,l.jsx)(n.code,{children:"headscale/fly-wireguard"})," and copy ",(0,l.jsx)(n.code,{children:"peer1.conf"})," to a new file called ",(0,l.jsx)(n.code,{children:"wg0.conf"}),"."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir -p ~/headscale/fly-wireguard\nnano ~/headscale/fly-wireguard/wg0.conf\n"})}),"\n",(0,l.jsx)(n.h3,{id:"install-docker-community-edition-via-the-convenience-script",children:"Install Docker community edition via the convenience script"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"curl -fsSL https://get.docker.com | sudo bash\nsudo usermod -aG docker $USER\n"})}),"\n",(0,l.jsx)(n.h3,{id:"configuring-headscale",children:"Configuring Headscale"}),"\n",(0,l.jsx)(n.p,{children:"Create a headscale folder, import the default configuration and tweak"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd ~/headscale\nmkdir config\nwget -O ./config/config.yaml https://raw.githubusercontent.com/juanfont/headscale/main/config-example.yaml\nnano config/config.yaml\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Settings to update in the ",(0,l.jsx)(n.code,{children:"config/config.yaml"})," file:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:'server_url: https://choose-a-subdomain-1234.fly.dev:443\nlisten_addr: 0.0.0.0:443\nacme_email: "you@example.com"\ntls_letsencrypt_hostname: "choose-a-subdomain-1234.fly.dev"\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"nano docker-compose.yml\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yml",children:'version: "2"\nservices:\n  headscale:\n    container_name: headscale\n    image: headscale/headscale\n    command: "headscale serve"\n    restart: unless-stopped\n    volumes:\n      - ./config:/etc/headscale/\n      - ./data:/var/lib/headscale/\n\n  fly-wireguard-peer:\n    container_name: headscale-fly-wireguard-peer\n    image: ghcr.io/digitallyrefined/docker-wireguard-tunnel:v3\n    restart: unless-stopped\n    environment:\n      # Note that DOMAIN & PEERS are not required for the peer\n      # Services to expose format (comma-separated)\n      # SERVICES=peer-id:peer-container-name:peer-container-port:expose-port-as\n      - SERVICES=peer1:headscale:80:80,peer1:headscale:443:443\n    cap_add:\n      - NET_ADMIN\n    links:\n      - headscale:headscale\n    volumes:\n      - ./fly-wireguard:/etc/wireguard\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker compose up -d\ndocker compose logs -f\n"})}),"\n",(0,l.jsxs)(n.p,{children:["After a few minutes you should now be able to access your new Headscale server by going to your subdomain ",(0,l.jsx)(n.code,{children:"https://choose-a-subdomain-1234.fly.dev/swagger"})]}),"\n",(0,l.jsx)(n.h4,{id:"create-a-new-user-for-your-headscale-server",children:"Create a new user for your Headscale server"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker exec headscale headscale users create my-user\n"})}),"\n",(0,l.jsx)(n.h3,{id:"joining-tailscale-clients-to-the-network-using-your-custom-control-server-url",children:"Joining Tailscale clients to the network using your custom control server URL"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/juanfont/headscale/blob/main/docs/windows-client.md",children:"Windows"})}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.a,{href:"https://github.com/juanfont/headscale/issues/106#issuecomment-918843218",children:"macOS"})," (and create a ",(0,l.jsx)(n.a,{href:"#create-a-new-preauth-key",children:"preauth key"}),")"]}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"#docker-compose-setup-to-run-tailscale-on-linux",children:"Linux"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/juanfont/headscale/blob/main/docs/android-client.md",children:"Android"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://github.com/juanfont/headscale/blob/main/docs/iOS-client.md",children:"iOS"})}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"registering-a-new-device-and-allowing-it-to-join-your-network",children:"Registering a new device and allowing it to join your network"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker exec headscale headscale nodes register --user my-user --key nodekey:...\n"})}),"\n",(0,l.jsx)(n.h3,{id:"docker-compose-setup-to-run-tailscale-on-linux",children:"Docker compose setup to run Tailscale on Linux"}),"\n",(0,l.jsx)(n.h4,{id:"create-a-new-preauth-key",children:"Create a new preauth key"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker exec headscale headscale --user my-user preauthkeys create --expiration 1h\n"})}),"\n",(0,l.jsx)(n.h4,{id:"docker-composeyml",children:"docker-compose.yml"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir ~/tailscale\ncd ~/tailscale\nnano docker-compose.yml\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Update the ",(0,l.jsx)(n.code,{children:"--login-server"})," URL and ",(0,l.jsx)(n.code,{children:"--advertise-routes"})," to match your network, then add the preauth key to the ",(0,l.jsx)(n.code,{children:"TS_AUTHKEY"})," environment variable (this key only used once on first run to join the network)."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yml",children:'services:\n  tailscale:\n    container_name: tailscale\n    image: tailscale/tailscale:stable\n    hostname: headtailscale\n    volumes:\n      - ./data:/var/lib/tailscale\n      - /dev/net/tun:/dev/net/tun\n    network_mode: "host"\n    cap_add:\n      - NET_ADMIN\n      - NET_RAW\n    environment:\n      - TS_STATE_DIR=/var/lib/tailscale\n      - TS_EXTRA_ARGS=--login-server=https://choose-a-subdomain-1234.fly.dev --advertise-exit-node --advertise-routes=192.168.x.0/24 --accept-dns=true\n      - TS_NO_LOGS_NO_SUPPORT=true\n      # - TS_AUTHKEY=...\n    restart: unless-stopped\n'})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker compose up -d\ndocker compose logs -f\n\ndocker exec headscale headscale nodes list\ndocker exec headscale headscale routes list\n\ndocker exec headscale headscale routes enable -r 1\ndocker exec headscale headscale routes enable -r 2 # 3 etc\n\ndocker exec headscale headscale routes list\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Now each of client should be able connect with each other and access local network resources if you have enabled ",(0,l.jsx)(n.code,{children:"--advertise-routes=192.168.x.0/24"})," and also be able to use your home internet connect while you're away via Tailscale ",(0,l.jsx)(n.code,{children:"-advertise-exit-node"})," argument."]}),"\n",(0,l.jsx)(n.h2,{id:"additional-resources",children:"Additional resources"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://tailscale.com/blog/how-tailscale-works/",children:"How Tailscale works"})}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)("a",{href:"https://youtu.be/wLrmmh1eI94?t=937",children:"Traefik HTTPS tutorial"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(r.Ay,{id:"wLrmmh1eI94",title:"Is this the BEST Reverse Proxy for Docker? // Traefik Tutorial",params:"start=937",poster:"maxresdefault",webp:!0})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(u,{...e})}):u(e)}},5883(e){e.exports=JSON.parse('{"permalink":"/guides/Tailscale-Headscale-setup","editUrl":"https://github.com/DigitallyRefined/DigitallyRefined.github.io/tree/main/blog/2023-06-01-Tailscale-Headscale-setup.mdx","source":"@site/blog/2023-06-01-Tailscale-Headscale-setup.mdx","title":"Tailscale & Headscale","description":"Setting up your own self hosted remote access","date":"2023-06-01T00:00:00.000Z","tags":[{"inline":true,"label":"Tailscale","permalink":"/tags/tailscale"},{"inline":true,"label":"VPN","permalink":"/tags/vpn"},{"inline":true,"label":"Tunnelling","permalink":"/tags/tunnelling"},{"inline":true,"label":"Self-hosting","permalink":"/tags/self-hosting"},{"inline":true,"label":"Docker","permalink":"/tags/docker"},{"inline":true,"label":"YouTube","permalink":"/tags/you-tube"},{"inline":true,"label":"Video","permalink":"/tags/video"}],"readingTime":6.37,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"/guides/Tailscale-Headscale-setup","tags":["Tailscale","VPN","Tunnelling","Self-hosting","Docker","YouTube","Video"],"last_update":{"date":"2024-05-19T00:00:00.000Z"}},"unlisted":false,"lastUpdatedAt":1716076800000,"prevItem":{"title":"Everything Presence Lite sensor","permalink":"/guides/Everything-Presence-Lite-sensor"},"nextItem":{"title":"IKEA VINDSTYRKA","permalink":"/guides/IKEA-VINDSTYRKA"}}')}}]);