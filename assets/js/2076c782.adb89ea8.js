"use strict";(self.webpackChunkdigitally_refined=self.webpackChunkdigitally_refined||[]).push([[318],{4078:e=>{e.exports=JSON.parse('{"permalink":"/guides/PVE-unprivileged-LXC-rootless-containers","editUrl":"https://github.com/DigitallyRefined/DigitallyRefined.github.io/tree/main/blog/2026-02-04-PVE-unprivileged-LXC-rootless-containers.mdx","source":"@site/blog/2026-02-04-PVE-unprivileged-LXC-rootless-containers.mdx","title":"Proxmox Unprivileged LXC Rootless Docker/Podman","description":"By default Proxmox Unprivileged LXC containers only allow running Docker/Podman as root. In this guide we will set up rootless Docker inside an unprivileged LXC container.","date":"2026-02-04T00:00:00.000Z","tags":[{"inline":true,"label":"Proxmox","permalink":"/tags/proxmox"},{"inline":true,"label":"LXC","permalink":"/tags/lxc"},{"inline":true,"label":"Self-hosting","permalink":"/tags/self-hosting"},{"inline":true,"label":"Docker","permalink":"/tags/docker"},{"inline":true,"label":"YouTube","permalink":"/tags/you-tube"},{"inline":true,"label":"Video","permalink":"/tags/video"}],"readingTime":10.15,"hasTruncateMarker":true,"authors":[],"frontMatter":{"slug":"/guides/PVE-unprivileged-LXC-rootless-containers","tags":["Proxmox","LXC","Self-hosting","Docker","YouTube","Video"],"last_update":{"date":"2026-02-05T00:00:00.000Z"}},"unlisted":false,"lastUpdatedAt":1770249600000,"nextItem":{"title":"Containers Up!","permalink":"/guides/Containers-Up"}}')},4252:(e,n,r)=>{r.d(n,{A:()=>i});r(6540);var t=r(5195);const o={tableOfContentsInline:"tableOfContentsInline_prmo"};var s=r(4848);function i({toc:e,minHeadingLevel:n,maxHeadingLevel:r}){return(0,s.jsx)("div",{className:o.tableOfContentsInline,children:(0,s.jsx)(t.A,{toc:e,minHeadingLevel:n,maxHeadingLevel:r,className:"table-of-contents",linkClassName:null})})}},5195:(e,n,r)=>{r.d(n,{A:()=>m});var t=r(6540),o=r(6342);function s(e){const n=e.map(e=>({...e,parentIndex:-1,children:[]})),r=Array(7).fill(-1);n.forEach((e,n)=>{const t=r.slice(2,e.level);e.parentIndex=Math.max(...t),r[e.level]=n});const t=[];return n.forEach(e=>{const{parentIndex:r,...o}=e;r>=0?n[r].children.push(o):t.push(o)}),t}function i({toc:e,minHeadingLevel:n,maxHeadingLevel:r}){return e.flatMap(e=>{const t=i({toc:e.children,minHeadingLevel:n,maxHeadingLevel:r});return function(e){return e.level>=n&&e.level<=r}(e)?[{...e,children:t}]:t})}function a(e){const n=e.getBoundingClientRect();return n.top===n.bottom?a(e.parentNode):n}function c(e,{anchorTopOffset:n}){const r=e.find(e=>a(e).top>=n);if(r){return function(e){return e.top>0&&e.bottom<window.innerHeight/2}(a(r))?r:e[e.indexOf(r)-1]??null}return e[e.length-1]??null}function l(){const e=(0,t.useRef)(0),{navbar:{hideOnScroll:n}}=(0,o.p)();return(0,t.useEffect)(()=>{e.current=n?0:document.querySelector(".navbar").clientHeight},[n]),e}function d(e){const n=(0,t.useRef)(void 0),r=l();(0,t.useEffect)(()=>{if(!e)return()=>{};const{linkClassName:t,linkActiveClassName:o,minHeadingLevel:s,maxHeadingLevel:i}=e;function a(){const e=function(e){return Array.from(document.getElementsByClassName(e))}(t),a=function({minHeadingLevel:e,maxHeadingLevel:n}){const r=[];for(let t=e;t<=n;t+=1)r.push(`h${t}.anchor`);return Array.from(document.querySelectorAll(r.join()))}({minHeadingLevel:s,maxHeadingLevel:i}),l=c(a,{anchorTopOffset:r.current}),d=e.find(e=>l&&l.id===function(e){return decodeURIComponent(e.href.substring(e.href.indexOf("#")+1))}(e));e.forEach(e=>{!function(e,r){r?(n.current&&n.current!==e&&n.current.classList.remove(o),e.classList.add(o),n.current=e):e.classList.remove(o)}(e,e===d)})}return document.addEventListener("scroll",a),document.addEventListener("resize",a),a(),()=>{document.removeEventListener("scroll",a),document.removeEventListener("resize",a)}},[e,r])}var h=r(8774),u=r(4848);function g({toc:e,className:n,linkClassName:r,isChild:t}){return e.length?(0,u.jsx)("ul",{className:t?void 0:n,children:e.map(e=>(0,u.jsxs)("li",{children:[(0,u.jsx)(h.A,{to:`#${e.id}`,className:r??void 0,dangerouslySetInnerHTML:{__html:e.value}}),(0,u.jsx)(g,{isChild:!0,toc:e.children,className:n,linkClassName:r})]},e.id))}):null}const p=t.memo(g);function m({toc:e,className:n="table-of-contents table-of-contents__left-border",linkClassName:r="table-of-contents__link",linkActiveClassName:a,minHeadingLevel:c,maxHeadingLevel:l,...h}){const g=(0,o.p)(),m=c??g.tableOfContents.minHeadingLevel,f=l??g.tableOfContents.maxHeadingLevel,x=function({toc:e,minHeadingLevel:n,maxHeadingLevel:r}){return(0,t.useMemo)(()=>i({toc:s(e),minHeadingLevel:n,maxHeadingLevel:r}),[e,n,r])}({toc:e,minHeadingLevel:m,maxHeadingLevel:f});return d((0,t.useMemo)(()=>{if(r&&a)return{linkClassName:r,linkActiveClassName:a,minHeadingLevel:m,maxHeadingLevel:f}},[r,a,m,f])),(0,u.jsx)(p,{toc:x,className:n,linkClassName:r,...h})}},7434:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>d});var t=r(4078),o=r(4848),s=r(8453),i=r(4252);const a={slug:"/guides/PVE-unprivileged-LXC-rootless-containers",tags:["Proxmox","LXC","Self-hosting","Docker","YouTube","Video"],last_update:{date:new Date("2026-02-05T00:00:00.000Z")}},c="Proxmox Unprivileged LXC Rootless Docker/Podman",l={authorsImageUrls:[]},d=[{value:"Installation",id:"installation",level:2},{value:"Video transcoding",id:"video-transcoding",level:2},{value:"Forgejo Actions via Docker in Docker (DinD)",id:"forgejo-actions-via-docker-in-docker-dind",level:2},{value:"Conclusion",id:"conclusion",level:2},{value:"Additional resources",id:"additional-resources",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["By default Proxmox Unprivileged LXC containers only allow running Docker/Podman as ",(0,o.jsx)(n.code,{children:"root"}),". In this guide we will set up rootless Docker inside an unprivileged LXC container."]}),"\n",(0,o.jsxs)(n.p,{children:["Allowing nesting namespaces three levels deep:",(0,o.jsx)("br",{}),"\n",(0,o.jsx)(n.strong,{children:"Proxmox Host"})," \u2192 ",(0,o.jsx)(n.strong,{children:"Unprivileged LXC"})," \u2192 ",(0,o.jsx)(n.strong,{children:"Rootless Docker/Podman"})," \u2192 ",(0,o.jsx)(n.strong,{children:"Docker in Docker (DinD)"}),"."]}),"\n","\n",(0,o.jsxs)(n.p,{children:["Running Docker or Podman as root can be a bit of a security risk, especially as we've seen quite an increase in malware such as the ",(0,o.jsx)(n.a,{href:"https://www.microsoft.com/en-us/security/blog/2025/12/09/shai-hulud-2-0-guidance-for-detecting-investigating-and-defending-against-the-supply-chain-attack/",children:"Shai-Hulud worm"})," and AI tools like ",(0,o.jsx)(n.a,{href:"https://github.com/openclaw/openclaw",children:"OpenClaw"})," gaining full access to your machine."]}),"\n",(0,o.jsx)(n.p,{children:"Running containers in an unprivileged LXC containers with rootless Docker/Podman adds an extra layer of security and reduces the blast radius, as even if a container is compromised, the attacker would still be limited by the unprivileged LXC and standard/non-admin user restrictions."}),"\n","\n",(0,o.jsx)(i.A,{toc:d}),"\n",(0,o.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,o.jsx)(n.p,{children:"After creating an unprivileged LXC container, first we'll need to navigate to our Proxmox dashboard and open up a console on the host."}),"\n",(0,o.jsxs)(n.p,{children:["Now we can run the ",(0,o.jsx)(n.a,{href:"https://gist.github.com/DigitallyRefined/37dfcc68a146c59e2215c2b5b5fabecc",children:"PVE LXC Unprivileged Rootless Docker script"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'bash -c "$(curl -fsSL https://gist.githubusercontent.com/DigitallyRefined/37dfcc68a146c59e2215c2b5b5fabecc/raw/3534b5c2e286fe4c57fb8f2367cef3349fb9f42a/pve-unprivileged-lxc-rootless-containers.sh)"\n'})}),"\n",(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsxs)(n.p,{children:["Please ",(0,o.jsx)(n.a,{href:"https://gist.github.com/DigitallyRefined/37dfcc68a146c59e2215c2b5b5fabecc",children:"review the script"})," before running it before running it on your system."]}),(0,o.jsx)(n.p,{children:"This script has been tested with a Debian 13 LXC on Proxmox 9.1."})]}),"\n",(0,o.jsxs)(n.p,{children:["Review the list of LXC containers and confirm that you want to continue, select ",(0,o.jsx)(n.code,{children:"Yes"})," on the GPU prompt and select the LXC container we created earlier from the list, once you confirm the script will run through the LXC containers adjusting the namespaces that we can use containers and container nesting (Docker in Docker) via non-root users."]}),"\n",(0,o.jsxs)(n.p,{children:["Once the script finishes updating the namespace, we need to SSH into the LXC container as root and install Docker and the ",(0,o.jsx)(n.code,{children:"uidmap"})," package and create a non-root user to run rootless Docker:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh root@192.168...\n\nwget -qO get-docker.sh https://get.docker.com\nsh get-docker.sh\n\napt install -y uidmap\n\nadduser user\n\nexit\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now that we have Docker installed, we can SSH into the container as the non-root user we created (",(0,o.jsx)(n.code,{children:"test"})," in this case) and set up rootless Docker and test that it works correctly:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh user@192.168...\n\ndockerd-rootless-setuptool.sh install\n\ndocker run --rm hello-world\n"})}),"\n",(0,o.jsx)(n.p,{children:'If this works correctly, you should see a "Hello from Docker!" message confirming that rootless Docker is working inside the unprivileged LXC container.'}),"\n",(0,o.jsx)(n.p,{children:"Now that we've confirmed rootless Docker is working, we can allow the Docker service to start on boot for the non-root user and disable the root Docker service:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh root@192.168...\nloginctl enable-linger user # replace 'user' with your non-root username\n\nsystemctl stop docker.service docker.socket\nsystemctl disable docker.service docker.socket\nsystemctl stop containerd.service\nsystemctl disable containerd.service\n"})}),"\n",(0,o.jsx)(n.h2,{id:"video-transcoding",children:"Video transcoding"}),"\n",(0,o.jsxs)(n.p,{children:["Now we have rootless Docker set up and working, we can try running a more complex container that uses hardware acceleration. In this example we'll use the ",(0,o.jsx)(n.code,{children:"linuxserver/ffmpeg"})," container to generate a test video via the GPU using Intel Quick Sync Video (QSV) hardware acceleration:"]}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"This example assumes that your Proxmox host has an Intel CPU with integrated graphics (with Quick Sync video support) and that you select GPU passthrough in the previous step. If you're using a different GPU (e.g., NVIDIA or AMD), you'll need to adjust the device mapping and ffmpeg parameters accordingly."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker run --rm -it \\\n  --device /dev/dri:/dev/dri \\\n  -v $(pwd):/data \\\n  linuxserver/ffmpeg \\\n  -y \\\n  -f lavfi -i testsrc=duration=5:size=1280x720:rate=30 \\\n  -f lavfi -i sine=frequency=1000:duration=5 \\\n  -c:v h264_qsv -preset fast -b:v 2M \\\n  -c:a aac -b:a 128k \\\n  -shortest /data/output.mp4\n\nls -lh output.mp4\n"})}),"\n",(0,o.jsxs)(n.p,{children:["If everything is set up correctly, you should see the output video file generated in the current directory, copying this back your computer should show that it created a 5 second ",(0,o.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Test_card",children:"test card"})," video with both video and audio streams."]}),"\n",(0,o.jsx)(n.p,{children:"This quick test shows that rootless Docker is able to access the GPU hardware acceleration from within an unprivileged LXC container and running Jellyfin or Plex should also run correctly."}),"\n",(0,o.jsx)(n.h2,{id:"forgejo-actions-via-docker-in-docker-dind",children:"Forgejo Actions via Docker in Docker (DinD)"}),"\n",(0,o.jsx)(n.p,{children:"Another benefit of using this script allowing unprivileged LXC rootless Docker is that we can now run Docker in Docker (DinD). This allows us to run CI/CD runners such as Forgejo Actions or GitHub Actions runners that can build and run Docker containers as part of their workflows."}),"\n",(0,o.jsxs)(r,{children:[(0,o.jsx)("summary",{children:"Click to expand Git/SSH setup instructions"}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"As root on the LXC"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh root@192.168...\napt install acl\nuseradd --system --create-home git\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"/etc/ssh/sshd_config"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ini",children:"Match User git\n    AuthorizedKeysCommandUser user # <-- replace with non-root user created earlier\n    AuthorizedKeysCommand /usr/local/bin/forgejo-authorized-keys.sh %u %t %k\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"/usr/local/bin/forgejo-authorized-keys.sh"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\nset -e\n\n/usr/bin/docker exec -i -u git forgejo \\\n  /usr/local/bin/forgejo keys \\\n  --config /var/lib/gitea/custom/conf/app.ini \\\n  -e git \\\n  -u "$1" \\\n  -t "$2" \\\n  -k "$3"\n'})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"chmod +x /usr/local/bin/forgejo-authorized-keys.sh\nsystemctl restart sshd\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"As non-root user on the LXC"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh user@192.168...\nsystemctl --user edit docker\n"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ini",children:"[Service]\nExecStartPost=/usr/bin/setfacl -m u:git:rw %t/docker.sock\nExecStartPost=/usr/bin/chmod +x %t\n"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"systemctl --user daemon-reload\nsystemctl --user restart docker\n"})})]}),"\n",(0,o.jsxs)(r,{children:[(0,o.jsx)("summary",{children:"Click to expand Traefik setup instructions"}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"As root on the LXC:"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"/etc/sysctl.d/99-custom.conf"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-conf",children:"net.ipv4.ping_group_range = 0 165535\nnet.ipv4.ip_unprivileged_port_start = 80\n"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"reboot\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"As non-root user on the LXC:"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"traefik/docker-compose.yml"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"services:\n  traefik:\n    # Check migration guide first: https://doc.traefik.io/traefik/v3.6/migrate/v3/\n    # https://github.com/traefik/traefik/releases\n    image: docker.io/traefik:v3.6.7\n    container_name: 'traefik'\n    restart: unless-stopped\n    ports:\n      - '80:80'\n      - '443:443'\n      # (Optional) Expose Dashboard\n      # - '8080:8080' # Don't do this in production!\n    volumes:\n      - ./data/config:/etc/traefik:ro\n      - ./data/certs:/certs\n      - ./data/plugins:/plugins-local:ro\n      - ${XDG_RUNTIME_DIR}/docker.sock:/var/run/docker.sock:ro\n    init: true\n    healthcheck:\n      test: wget --quiet --tries=1 --spider http://127.0.0.1/ping || bash -c 'kill -s 15 -1 && (sleep 10; kill -s 9 -1)'\n      interval: 30s\n      timeout: 60s\n      retries: 3\n      start_period: 10s\n    environment:\n      - LEGO_DISABLE_CNAME_SUPPORT=true\n    env_file:\n      - .env\n    networks:\n      - 'traefik'\n    labels:\n      traefik.enable: true\n\n      traefik.http.routers.traefik-ping.rule: Host(`127.0.0.1`) && Path(`/ping`)\n      traefik.http.routers.traefik-ping.entrypoints: web\n      # Override HTTPS redirect\n      traefik.http.routers.traefik-ping.priority: 2000\n\nnetworks:\n  traefik:\n    external: true\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"traefik/.env"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-env",children:"DESEC_TOKEN= # Add your deSEC API token\n"})}),(0,o.jsxs)(n.p,{children:["This example uses deSEC as the provider for Let's Encrypt DNS challenges, you can register for a free subdomain and get an API token from your ",(0,o.jsx)(n.a,{href:"https://desec.io/",children:"deSEC account"})," or bring your own domain."]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"traefik/config/traefik.yml"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'entryPoints:\n  web:\n    address: :80\n    # (Optional) Redirect to HTTPS\n    # ---\n    http:\n      redirections:\n        entryPoint:\n          to: websecure\n          scheme: https\n          priority: 1000\n\n  websecure:\n    address: ":443"\n    http:\n      tls:\n        certResolver: production-desec-dns\n        domains:\n          - main: "example.dedyn.io"\n            sans:\n              - "*.example.dedyn.io"\n\nping:\n  entryPoint: web\n\ncertificatesResolvers:\n  # Staging environment (for testing)\n  staging-desec-dns:\n    acme:\n      dnsChallenge:\n        provider: desec\n        propagation:\n          delayBeforeChecks: 240\n      email: you@example.com\n      storage: /certs/acme-letsencrypt-staging-desec-dns.json\n      caServer: \'https://acme-staging-v02.api.letsencrypt.org/directory\'\n\n  # Production (after making sure staging works, as Let\'s Encrypt rate limits failed attempts/restarts)\n  production-desec-dns:\n    acme:\n      dnsChallenge:\n        provider: desec\n        propagation:\n          delayBeforeChecks: 240\n      email: you@example.com\n      storage: /certs/acme-letsencrypt-production-desec-dns.json\n\nproviders:\n  docker:\n    exposedByDefault: false  # Default is true\n'})})]}),"\n",(0,o.jsxs)(r,{children:[(0,o.jsx)("summary",{children:"Click to expand Forgejo Actions via DinD setup instructions"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"ssh user@192.168...\nmkdir -p forgejo/runner\ncd forgejo\nmkdir -p ./data/var/lib/gitea ./data/etc/gitea ./data/etc/act_runner\nsudo chown -R 100999:100999 data\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"forgejo/docker-compose.yml"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'services:\n  forgejo:\n    # https://codeberg.org/forgejo/forgejo/releases\n    image: codeberg.org/forgejo/forgejo:14.0.1-rootless\n    container_name: forgejo\n    restart: unless-stopped\n    user: 1000:1000\n    # ports:\n    #   - \'3000:3000\'\n    #   - \'222:2222\'\n    volumes:\n      - ./data/var/lib/gitea:/var/lib/gitea\n      - ./data/etc/gitea:/etc/gitea\n      - /etc/timezone:/etc/timezone:ro\n      - /etc/localtime:/etc/localtime:ro\n    environment:\n      - USER_UID=1000\n      - USER_GID=1000\n      - FORGEJO__actions__ENABLED=true\n      - FORGEJO__webhook__ALLOWED_HOST_LIST=private,100.64.0.0/10\n      - FORGEJO__repository.pull-request__DEFAULT_MERGE_STYLE=squash\n      - FORGEJO__repository__USE_COMPAT_SSH_URI=false\n      - FORGEJO__server__START_SSH_SERVER=false\n      - FORGEJO__server__SSH_PORT=22\n      - FORGEJO__server__SSH_AUTHORIZED_KEYS_COMMAND_TEMPLATE=/usr/bin/docker -H unix://${XDG_RUNTIME_DIR}/docker.sock exec -i -e SSH_ORIGINAL_COMMAND -u git forgejo {{.AppPath}} --config={{.CustomConf}} serv key-{{.Key.ID}}\n    healthcheck:\n      test: ["CMD", "curl", "-f", "http://localhost:3000/"]\n      interval: 5s\n      retries: 10\n      timeout: 5s\n    networks:\n      - "traefik"\n    labels:\n      traefik.enable: true\n      traefik.http.routers.forgejo.entrypoints: web,websecure\n      traefik.http.routers.forgejo.rule: Host(`forgejo.example.dedyn.io`)\n      traefik.http.routers.forgejo.tls: true\n      traefik.http.routers.forgejo.tls.certresolver: production-desec-dns\n      traefik.http.services.forgejo.loadbalancer.server.port: 3000\n\n  dind:\n    # https://github.com/moby/moby/releases\n    image: docker:29.1.5-dind\n    container_name: dind\n    restart: unless-stopped\n    privileged: true            # DinD requires privileged (within rootless Docker)\n    ports:\n      - "2375:2375"\n    environment:\n      DOCKER_TLS_CERTDIR: ""    # disable TLS for simplicity internal only\n    healthcheck:\n      test: ["CMD", "docker", "info"]\n      interval: 2s\n      timeout: 2s\n      retries: 10\n    volumes:\n      - dind-data:/var/lib/docker\n    networks:\n      - "traefik"\n\n  runner:\n    # https://code.forgejo.org/forgejo/runner/releases\n    image: data.forgejo.org/forgejo/runner:12.6.2\n    container_name: forgejo-runner\n    restart: unless-stopped\n    depends_on:\n      forgejo:\n        condition: service_healthy\n      dind:\n        condition: service_healthy\n    environment:\n      # Point runner to the DinD daemon\n      DOCKER_HOST: tcp://dind:2375\n    env_file:\n      - ./.env-runner\n    volumes:\n      - runner-data:/data\n      - ./data/etc/act_runner:/etc/act_runner\n      - ./runner/config.yaml:/etc/act_runner/config.yaml\n    networks:\n      - "traefik"\n    command:\n      - bash\n      - -c\n      - |\n        if [ ! -f /etc/act_runner/.runner ]; then\n          pushd /etc/act_runner\n          forgejo-runner register --no-interactive \\\n            --instance https://forgejo.example.dedyn.io \\\n            --name dind-runner \\\n            --labels docker \\\n            --token "$$FORGEJO_RUNNER_REGISTRATION_TOKEN"\n          popd\n        fi\n        ln -sf /etc/act_runner/.runner .\n        forgejo-runner --config /etc/act_runner/config.yaml daemon\n\nvolumes:\n  runner-data:\n  dind-data:\n\nnetworks:\n  traefik:\n    external: true\n'})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"forgejo/runner/config.yaml"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"runner:\n  envs:\n    DOCKER_HOST: tcp://forgejo.example.dedyn.io:2375 # <- replace with your LXC hostname\n"})}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.code,{children:"forgejo/.env-runner"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"FORGEJO_RUNNER_REGISTRATION_TOKEN= # Add your Forgejo Actions runner registration token\n"})})]}),"\n",(0,o.jsx)(n.p,{children:"Once the files are in place, we can start the Forgejo, Actions, DinD and Traefik services:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"docker network create traefik\ndocker compose -f traefik/docker-compose.yml up -d\ndocker compose -f forgejo/docker-compose.yml up -d\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsxs)(n.p,{children:["It can take take around 5 minutes for HTTPS/TLS certificates to be issued, keep the service running monitoring ",(0,o.jsx)(n.code,{children:"docker compose -f traefik/docker-compose.yml logs -f"})," and check in the ",(0,o.jsx)(n.code,{children:"certs"})," folder, as there will be a new section added to the JSON files under ",(0,o.jsx)(n.code,{children:"PrivateKey"})," with a ",(0,o.jsx)(n.code,{children:"Certificates"})," section once issued."]}),(0,o.jsxs)(n.p,{children:["When first starting Traefik, it's recommended to use the ",(0,o.jsx)(n.code,{children:"staging-desec-dns"})," resolver to avoid hitting Let's Encrypt rate limits while testing your setup. Once confirmed working, switch to ",(0,o.jsx)(n.code,{children:"production-desec-dns"}),"."]})]}),"\n",(0,o.jsxs)(n.p,{children:["Once Traefik and Forgejo are up and running, you should be able to navigate to your Forgejo instance using the URL you set earlier, e.g. ",(0,o.jsx)(n.code,{children:"https://forgejo.example.dedyn.io"}),", and follow the installation wizard."]}),"\n",(0,o.jsxs)(n.p,{children:["After setting up your Forgejo instance, navigate to ",(0,o.jsx)(n.strong,{children:"Site administration"})," \u2192 ",(0,o.jsx)(n.strong,{children:"Actions"})," \u2192 ",(0,o.jsx)(n.strong,{children:"Runners"})," to create a new Action runner and copy the registration token into the ",(0,o.jsx)(n.code,{children:"FORGEJO_RUNNER_REGISTRATION_TOKEN"})," variable in the ",(0,o.jsx)(n.code,{children:"forgejo/.env-runner"})," file and use ",(0,o.jsx)(n.code,{children:"docker compose -f forgejo/docker-compose.yml up -d --force-recreate"})," to pickup the new token and start the runner."]}),"\n",(0,o.jsxs)(n.p,{children:["Create a new Access token from ",(0,o.jsx)(n.strong,{children:"Applications"})," in your Forgejo account settings, with ",(0,o.jsx)(n.code,{children:"issue"}),", ",(0,o.jsx)(n.code,{children:"misc"}),", ",(0,o.jsx)(n.code,{children:"organization"}),", ",(0,o.jsx)(n.code,{children:"package"}),", and ",(0,o.jsx)(n.code,{children:"repository"})," permissions and add it as a secret named ",(0,o.jsx)(n.code,{children:"ACTIONS_TOKEN"})," under ",(0,o.jsx)(n.strong,{children:"Actions"})," \u2192 ",(0,o.jsx)(n.strong,{children:"Secrets"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Now workflows that use Docker will be able to run inside the unprivileged LXC container using rootless Docker in Docker (DinD)."}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsxs)(n.p,{children:["Running the Docker daemon as ",(0,o.jsx)(n.code,{children:"root"})," or simply granting a user Docker access via the ",(0,o.jsx)(n.code,{children:"docker"})," group creates a large, unnecessary attack surface. I learned this the hard way: a typo in ",(0,o.jsx)(n.code,{children:"sudoers"})," locked me out of one of my servers, and because Docker runs as ",(0,o.jsx)(n.code,{children:"root"})," I was able to mount and fix the file from a container, a capability that should not have been possible."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Why unprivileged LXCs + rootless Docker matters"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Reduced blast radius: compromises are confined to the unprivileged LXC and the non-root user."}),"\n",(0,o.jsx)(n.li,{children:"Safer CI/runner workflows: enables Docker-in-Docker (DinD) for runners without exposing host-level Docker."}),"\n",(0,o.jsx)(n.li,{children:"Practical: GPU passthrough and hardware-accelerated workloads still work when configured correctly."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"For production and self-hosting deployments, prefer running container engines rootless inside unprivileged LXC containers, as it preserves container convenience while significantly lowering host risk."}),"\n",(0,o.jsx)(n.h2,{id:"additional-resources",children:"Additional resources"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://gist.github.com/DigitallyRefined/37dfcc68a146c59e2215c2b5b5fabecc",children:"PVE LXC Unprivileged Rootless Docker - pve-unprivileged-lxc-rootless-containers.sh"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.docker.com/engine/security/rootless/",children:"Docker Rootless Mode"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.docker.com/resources/docker-in-docker-containerized-ci-workflows-dockercon-2023/",children:"Docker in Docker (DinD)"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://pve.proxmox.com/wiki/Unprivileged_LXC_containers",children:"Proxmox Unprivileged LXC Containers"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var t=r(6540);const o={},s=t.createContext(o);function i(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);