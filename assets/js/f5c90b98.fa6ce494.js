"use strict";(self.webpackChunkdigitally_refined=self.webpackChunkdigitally_refined||[]).push([[418],{3905:(e,a,t)=>{t.d(a,{Zo:()=>d,kt:()=>h});var n=t(7294);function o(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function r(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?r(Object(t),!0).forEach((function(a){o(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function i(e,a){if(null==e)return{};var t,n,o=function(e,a){if(null==e)return{};var t,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||(o[t]=e[t]);return o}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=n.createContext({}),c=function(e){var a=n.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},d=function(e){var a=c(e.components);return n.createElement(s.Provider,{value:a},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var t=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),u=c(t),m=o,h=u["".concat(s,".").concat(m)]||u[m]||p[m]||r;return t?n.createElement(h,l(l({ref:a},d),{},{components:t})):n.createElement(h,l({ref:a},d))}));function h(e,a){var t=arguments,o=a&&a.mdxType;if("string"==typeof e||o){var r=t.length,l=new Array(r);l[0]=m;var i={};for(var s in a)hasOwnProperty.call(a,s)&&(i[s]=a[s]);i.originalType=e,i[u]="string"==typeof e?e:o,l[1]=i;for(var c=2;c<r;c++)l[c]=t[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},7610:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>s,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=t(7462),o=(t(7294),t(3905));const r={sidebar_position:2},l="Tailscale & Headscale",i={unversionedId:"guides/Tailscale-Headscale-setup",id:"guides/Tailscale-Headscale-setup",title:"Tailscale & Headscale",description:"Setting up your own self hosted remote access",source:"@site/docs/guides/Tailscale-Headscale-setup.md",sourceDirName:"guides",slug:"/guides/Tailscale-Headscale-setup",permalink:"/guides/Tailscale-Headscale-setup",draft:!1,editUrl:"https://github.com/DigitallyRefined/DigitallyRefined.github.io/tree/main/docs/guides/Tailscale-Headscale-setup.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"",permalink:"/"},next:{title:"IKEA VINDSTYRKA",permalink:"/guides/IKEA-VINDSTYRKA"}},s={},c=[{value:"Setting up your own self hosted remote access",id:"setting-up-your-own-self-hosted-remote-access",level:2},{value:"Video",id:"video",level:2},{value:"Installation",id:"installation",level:2},{value:"Fly.io client",id:"flyio-client",level:3},{value:"Fly.io deployment",id:"flyio-deployment",level:3},{value:"Launching the Fly.io app",id:"launching-the-flyio-app",level:3},{value:"Setting up the Fly.io docker-wireguard-tunnel",id:"setting-up-the-flyio-docker-wireguard-tunnel",level:3},{value:"Install Docker community edition via the convenience script",id:"install-docker-community-edition-via-the-convenience-script",level:3},{value:"Configuring Headscale",id:"configuring-headscale",level:3},{value:"Create a new user for your Headscale server",id:"create-a-new-user-for-your-headscale-server",level:4},{value:"Joining Tailscale clients to the network using your custom control server URL",id:"joining-tailscale-clients-to-the-network-using-your-custom-control-server-url",level:3},{value:"Registering a new device and allowing it to join your network",id:"registering-a-new-device-and-allowing-it-to-join-your-network",level:4},{value:"Docker compose setup to run Tailscale on Linux",id:"docker-compose-setup-to-run-tailscale-on-linux",level:3},{value:"Create a new preauth key",id:"create-a-new-preauth-key",level:4},{value:"docker-compose.yml",id:"docker-composeyml",level:4},{value:"Additional resources",id:"additional-resources",level:2}],d=(u="TOCInline",function(e){return console.warn("Component "+u+" was not imported, exported, or provided by MDXProvider as global scope"),(0,o.kt)("div",e)});var u;const p={toc:c},m="wrapper";function h(e){let{components:a,...t}=e;return(0,o.kt)(m,(0,n.Z)({},p,t,{components:a,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"tailscale--headscale"},"Tailscale & Headscale"),(0,o.kt)("h2",{id:"setting-up-your-own-self-hosted-remote-access"},"Setting up your own self hosted remote access"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://headscale.net/"},"Headscale")," is an open source implementation of the ",(0,o.kt)("a",{parentName:"p",href:"https://tailscale.com/"},"Tailscale")," coordination server."),(0,o.kt)("p",null,"This guide will step through setting up your own self hosted private and secure remote access. This is currently my preferred setup using Tailscale clients along with a self hosted Headscale Docker container."),(0,o.kt)(d,{toc:c,mdxType:"TOCInline"}),(0,o.kt)("h2",{id:"video"},"Video"),(0,o.kt)("div",{className:"remark-oembed-inline remark-oembed-you-tube","data-oembed":""},(0,o.kt)("a",{parentName:"div",href:"https://youtu.be/rGJ5RvB_aBg",className:"remark-oembed-anchor","data-oembed":"",rel:"noopener noreferrer nofollow",target:"_blank"},(0,o.kt)("img",{parentName:"a",src:"https://i.ytimg.com/vi/rGJ5RvB_aBg/hqdefault.jpg",title:"Tailscale & Headscale - Setting up your own self hosted remote access",width:200,height:113,className:"remark-oembed-photo","data-oembed":""})),(0,o.kt)("template",{parentName:"div","data-oembed-template":""})),(0,o.kt)("a",{href:"https://youtu.be/rGJ5RvB_aBg"},"Watch on YouTube"),(0,o.kt)("h2",{id:"installation"},"Installation"),(0,o.kt)("h3",{id:"flyio-client"},"Fly.io client"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt install curl\ncurl -L https://fly.io/install.sh | sh\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"echo 'export FLYCTL_INSTALL=\"$HOME/.fly\"' >> ~/.bashrc\necho 'export PATH=\"$FLYCTL_INSTALL/bin:$PATH\"' >> ~/.bashrc\n")),(0,o.kt)("h3",{id:"flyio-deployment"},"Fly.io deployment"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir fly-tunnel\ncd fly-tunnel\nnano fly.toml\n")),(0,o.kt)("p",null,"Note: you can update ",(0,o.kt)("inlineCode",{parentName:"p"},"choose-a-subdomain-1234")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"my-user")," to any value you'd like to use."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},'# fly.toml app configuration file\n#\n# See https://fly.io/docs/reference/configuration/ for information about how to use this file.\n#\n\napp = "choose-a-subdomain-1234"\n\n[build]\n  image = "ghcr.io/digitallyrefined/docker-wireguard-tunnel:v2"\n\n[env]\n  DOMAIN = "choose-a-subdomain-1234.fly.dev"\n  PEERS = "1"\n  SERVICES = "peer1:headscale:80:80,peer1:headscale:443:443"\n\n[[mounts]]\n  source = "wireguard_data"\n  destination = "/etc/wireguard"\n\n[[services]]\n  protocol = "udp"\n  internal_port = 51820\n\n  [[services.ports]]\n    port = 51820\n\n[[services]]\n  protocol = "tcp"\n  internal_port = 80\n\n  [[services.ports]]\n    port = 80\n\n[[services]]\n  protocol = "tcp"\n  internal_port = 443\n\n  [[services.ports]]\n    port = 443\n')),(0,o.kt)("h3",{id:"launching-the-flyio-app"},"Launching the Fly.io app"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://fly.io/app/sign-up"},"Sign up for a free Fly.io account")),(0,o.kt)("p",null,"This setup uses 1 Fly.io app. As long as you don't have more than 3 Fly.io apps running you wont be exceeding ",(0,o.kt)("a",{parentName:"p",href:"https://fly.io/docs/about/pricing/#free-allowances"},"Fly.io's free allowance"),", but you will need to add a credit card to launch this app. You can use a temporary credit card from ",(0,o.kt)("a",{parentName:"p",href:"https://privacy.com/"},"privacy.com")," in the US or ",(0,o.kt)("a",{parentName:"p",href:"https://www.revolut.com/"},"Revolut")," in some parts of Europe. Make sure that you check ",(0,o.kt)("a",{parentName:"p",href:"https://fly.io/docs/about/pricing/#free-allowances"},"their current free allowances"),", as they may have changed since this guide was published."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"fly auth login\nfly launch\n")),(0,o.kt)("p",null,"Use the following options:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"? Would you like to copy its configuration to the new app? Yes\n? Choose an app name (leaving blank will default to 'choose-a-subdomain-1234') choose-a-subdomain-1234\n? Choose a region for deployment: Denver, Colorado (US) (den) # Or a location closest to you\n? Would you like to set up a Postgresql database now? No\n? Would you like to set up an Upstash Redis database now? No\n? Would you like to deploy now? Yes\n? Would you like to allocate a dedicated ipv4 address now? Yes\n")),(0,o.kt)("h3",{id:"setting-up-the-flyio-docker-wireguard-tunnel"},"Setting up the Fly.io ",(0,o.kt)("a",{parentName:"h3",href:"https://github.com/DigitallyRefined/docker-wireguard-tunnel"},"docker-wireguard-tunnel")),(0,o.kt)("p",null,"Once the Fly.io tunnel has started, a ",(0,o.kt)("inlineCode",{parentName:"p"},"peer1.conf")," file will be automatically generated in the ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/wireguard")," directory, it can be viewed and then removed via:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"fly ssh console\ncat /etc/wireguard/peer1.conf\n# Copy the contents of peer1.conf\nrm /etc/wireguard/peer1.conf\n")),(0,o.kt)("p",null,"Now we'll create a new folder called ",(0,o.kt)("inlineCode",{parentName:"p"},"headscale/fly-wireguard")," and copy ",(0,o.kt)("inlineCode",{parentName:"p"},"peer1.conf")," to a new file called ",(0,o.kt)("inlineCode",{parentName:"p"},"wg0.conf"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p ~/headscale/fly-wireguard\nnano ~/headscale/fly-wireguard/wg0.conf\n")),(0,o.kt)("h3",{id:"install-docker-community-edition-via-the-convenience-script"},"Install Docker community edition via the convenience script"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl -fsSL https://get.docker.com | sudo bash\nsudo usermod -aG docker $USER\n")),(0,o.kt)("h3",{id:"configuring-headscale"},"Configuring Headscale"),(0,o.kt)("p",null,"Create a headscale folder, import the default configuration and tweak"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/headscale\nmkdir config\nwget -O ./config/config.yaml https://raw.githubusercontent.com/juanfont/headscale/main/config-example.yaml\nnano config/config.yaml\n")),(0,o.kt)("p",null,"Settings to update in the ",(0,o.kt)("inlineCode",{parentName:"p"},"config/config.yaml")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'server_url: https://choose-a-subdomain-1234.fly.dev:443\nlisten_addr: 0.0.0.0:443\nacme_email: "you@example.com"\ntls_letsencrypt_hostname: "choose-a-subdomain-1234.fly.dev"\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano docker-compose.yml\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yml"},'version: "2"\nservices:\n  headscale:\n    container_name: headscale\n    image: headscale/headscale\n    command: "headscale serve"\n    restart: unless-stopped\n    volumes:\n      - ./config:/etc/headscale/\n      - ./data:/var/lib/headscale/\n\n  fly-wireguard-peer:\n    container_name: headscale-fly-wireguard-peer\n    image: ghcr.io/digitallyrefined/docker-wireguard-tunnel:v2\n    restart: unless-stopped\n    environment:\n      # Note that DOMAIN & PEERS are not required for the peer\n      # Services to expose format (comma-separated)\n      # SERVICES=peer-id:peer-container-name:peer-container-port:expose-port-as\n      - SERVICES=peer1:headscale:80:80,peer1:headscale:443:443\n    cap_add:\n      - NET_ADMIN\n    links:\n      - headscale:headscale\n    volumes:\n      - ./fly-wireguard:/etc/wireguard\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker compose up -d\ndocker compose logs -f\n")),(0,o.kt)("p",null,"After a few minutes you should now be able to access your new Headscale server by going to your subdomain ",(0,o.kt)("inlineCode",{parentName:"p"},"https://choose-a-subdomain-1234.fly.dev/swagger")),(0,o.kt)("h4",{id:"create-a-new-user-for-your-headscale-server"},"Create a new user for your Headscale server"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker exec headscale headscale users create my-user\n")),(0,o.kt)("h3",{id:"joining-tailscale-clients-to-the-network-using-your-custom-control-server-url"},"Joining Tailscale clients to the network using your custom control server URL"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/juanfont/headscale/blob/main/docs/windows-client.md"},"Windows")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/juanfont/headscale/issues/106#issuecomment-918843218"},"macOS")," (and create a ",(0,o.kt)("a",{parentName:"li",href:"#create-a-new-preauth-key"},"preauth key"),")"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#docker-compose-setup-to-run-tailscale-on-linux"},"Linux")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/juanfont/headscale/blob/main/docs/android-client.md"},"Android")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/juanfont/headscale/blob/main/docs/iOS-client.md"},"iOS"))),(0,o.kt)("h4",{id:"registering-a-new-device-and-allowing-it-to-join-your-network"},"Registering a new device and allowing it to join your network"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker exec headscale headscale nodes register --user my-user --key nodekey:...\n")),(0,o.kt)("h3",{id:"docker-compose-setup-to-run-tailscale-on-linux"},"Docker compose setup to run Tailscale on Linux"),(0,o.kt)("h4",{id:"create-a-new-preauth-key"},"Create a new preauth key"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker exec headscale headscale --user my-user preauthkeys create --expiration 1h\n")),(0,o.kt)("h4",{id:"docker-composeyml"},"docker-compose.yml"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir ~/tailscale\ncd ~/tailscale\nnano docker-compose.yml\n")),(0,o.kt)("p",null,"Update the ",(0,o.kt)("inlineCode",{parentName:"p"},"--login-server")," URL and ",(0,o.kt)("inlineCode",{parentName:"p"},"--advertise-routes")," to match your network, then add the preauth key to the ",(0,o.kt)("inlineCode",{parentName:"p"},"TS_AUTHKEY")," environment variable (this key only used once on first run to join the network)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yml"},'services:\n  tailscale:\n    container_name: tailscale\n    image: tailscale/tailscale:stable\n    hostname: headtailscale\n    volumes:\n      - ./data:/var/lib/tailscale\n      - /dev/net/tun:/dev/net/tun\n    network_mode: "host"\n    cap_add:\n      - NET_ADMIN\n      - NET_RAW\n    environment:\n      - TS_STATE_DIR=/var/lib/tailscale\n      - TS_EXTRA_ARGS=--login-server=https://choose-a-subdomain-1234.fly.dev --advertise-exit-node --advertise-routes=192.168.x.0/24 --accept-dns=true\n      - TS_NO_LOGS_NO_SUPPORT=true\n      # - TS_AUTHKEY=...\n    restart: unless-stopped\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker compose up -d\ndocker compose logs -f\n\ndocker exec headscale headscale nodes list\ndocker exec headscale headscale routes list\n\ndocker exec headscale headscale routes enable -r 1\ndocker exec headscale headscale routes enable -r 2 # 3 etc\n\ndocker exec headscale headscale routes list\n")),(0,o.kt)("p",null,"Now each of client should be able connect with each other and access local network resources if you have enabled ",(0,o.kt)("inlineCode",{parentName:"p"},"--advertise-routes=192.168.x.0/24")," and also be able to use your home internet connect while you're away via Tailscale ",(0,o.kt)("inlineCode",{parentName:"p"},"-advertise-exit-node")," argument."),(0,o.kt)("h2",{id:"additional-resources"},"Additional resources"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://tailscale.com/blog/how-tailscale-works/"},"How Tailscale works")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{href:"https://youtu.be/wLrmmh1eI94?t=937"},"Traefik HTTPS tutorial"))),(0,o.kt)("div",{className:"remark-oembed-inline remark-oembed-you-tube","data-oembed":""},(0,o.kt)("a",{parentName:"div",href:"https://youtu.be/wLrmmh1eI94?t=937",className:"remark-oembed-anchor","data-oembed":"",rel:"noopener noreferrer nofollow",target:"_blank"},(0,o.kt)("img",{parentName:"a",src:"https://i.ytimg.com/vi/wLrmmh1eI94/hqdefault.jpg",title:"Is this the BEST Reverse Proxy for Docker? // Traefik Tutorial",width:200,height:113,className:"remark-oembed-photo","data-oembed":""})),(0,o.kt)("template",{parentName:"div","data-oembed-template":""})),(0,o.kt)("script",{async:!0,defer:!0},"\n    const isDocumentReady = () => {\n      if (document.readyState !== 'complete') {\n        document.addEventListener('readystatechange', isDocumentReady);\n        return false;\n      }\n\n      requestAnimationFrame(() => {\n        \n    document.querySelectorAll('div[data-oembed]').forEach((el) => {\n      const template = el.querySelector('[data-oembed-template]').content.cloneNode(true);\n      el.innerHTML = '';\n      el.attachShadow({ mode: 'closed' }).appendChild(template);\n    });\n\n    document.querySelectorAll('img[data-oembed][data-src]').forEach((img) => {\n      img.setAttribute('src', img.getAttribute('data-src'));\n      img.removeAttribute('data-src');\n    });\n\n    document.querySelectorAll('[data-oembed]').forEach((el) => {\n      el.removeAttribute('data-oembed');\n    });\n  ;\n      });\n\n      return true;\n    };\n\n    if (!isDocumentReady()) {\n      document.addEventListener('readystatechange', isDocumentReady);\n    }\n  "))}h.isMDXComponent=!0}}]);